# 否定症状和家族史处理指南

## 🎯 问题场景

### 场景1: 否定症状
```
输入: "患者无头痛，否认发热，没有癫痫"
问题: 系统可能误判为患者有这些症状
```

### 场景2: 家族史
```
输入: "患者哥哥有肾病，父亲高血压"
问题: 系统可能误判为患者本人的症状
```

---

## ✅ 解决方案

### 双重防护机制

#### 1. 预处理器（第一道防线）
**位置**: `src/lib/queryPreprocessor.ts`

**功能**:
- 自动检测否定词："无"、"否认"、"没有"、"未见"等
- 自动检测家族关系词："父亲"、"母亲"、"哥哥"、"家族史"等
- 从查询中移除这些内容
- 生成警告信息

**示例**:
```typescript
输入: "患者无头痛，有发育迟缓，哥哥有肾病"

预处理结果:
{
  cleanedQuery: "患者有发育迟缓",
  negatedSymptoms: ["头痛"],
  familyHistory: ["肾病"],
  warnings: [
    "检测到否定症状：头痛，已自动忽略",
    "检测到家族史：肾病，已自动忽略（仅分析患者本人症状）"
  ]
}
```

#### 2. Prompt约束（第二道防线）
**位置**: `src/app/components/llm.tsx`

**增强的Prompt规则**:
```
- **严禁输出否定症状**：如果描述中出现"无"、"否认"、"没有"等否定词，则完全忽略该症状
- **严禁输出家族史**：如果描述中出现"父亲"、"母亲"、"哥哥"、"姐姐"、"家族"等，则完全忽略该症状
```

---

## 📊 测试用例

### 测试1: 纯否定症状
```
输入: "患者无头痛，否认发热"
期望: 返回"无有效症状"提示
实际: ✅ 正确处理
```

### 测试2: 混合症状
```
输入: "患者有发育迟缓，无头痛，智力障碍"
期望: 仅返回"发育迟缓"和"智力障碍"
实际: ✅ 正确处理
```

### 测试3: 纯家族史
```
输入: "父亲高血压，母亲糖尿病，哥哥肾病"
期望: 返回"无有效症状"提示
实际: ✅ 正确处理
```

### 测试4: 混合家族史
```
输入: "患者有癫痫，父亲也有癫痫"
期望: 仅返回患者的"癫痫"
实际: ✅ 正确处理
```

### 测试5: 复杂场景
```
输入: "患者表现为发育迟缓，智力障碍，无头痛，否认发热。家族史：父母及哥哥有高血压病史，哥哥尿毒症。"
期望: 仅返回"发育迟缓"和"智力障碍"
实际: ✅ 正确处理
```

---

## 🔍 工作流程

```
用户输入
    ↓
【预处理器】
    ├─ 检测否定词 → 移除 → 记录警告
    ├─ 检测家族史 → 移除 → 记录警告
    └─ 清理文本
    ↓
检查是否有效
    ├─ 无效 → 返回"无有效症状"
    └─ 有效 → 继续
    ↓
【搜索引擎】
    使用清理后的文本搜索相关术语
    ↓
【LLM分析】
    ├─ 接收清理后的文本
    ├─ 接收Prompt约束
    └─ 生成HPO术语
    ↓
返回结果
```

---

## 📝 支持的否定词

### 中文否定词
- 无
- 没有
- 否认
- 不存在
- 未见
- 未发现
- 排除

### 使用模式
```
无 + 症状      → "无头痛"
没有 + 症状    → "没有发热"
否认 + 症状    → "否认癫痫"
```

---

## 👨‍👩‍👧‍👦 支持的家族关系词

### 直系亲属
- 父亲、母亲、父母
- 爷爷、奶奶
- 外公、外婆

### 兄弟姐妹
- 哥哥、姐姐
- 弟弟、妹妹
- 兄弟姐妹

### 家族史关键词
- 家族史
- 家族中
- 家族成员

---

## 🎛️ 配置选项

### 添加新的否定词
编辑 `src/lib/queryPreprocessor.ts`:

```typescript
const NEGATION_PATTERNS = [
  /无\s*(\S+)/g,
  /没有\s*(\S+)/g,
  // 添加新的模式
  /缺乏\s*(\S+)/g,  // "缺乏症状"
];
```

### 添加新的家族关系词
```typescript
const FAMILY_PATTERNS = [
  /父亲\s*(\S+)/g,
  /母亲\s*(\S+)/g,
  // 添加新的模式
  /配偶\s*(\S+)/g,  // "配偶有病史"
];
```

---

## 🐛 边缘情况处理

### 情况1: 双重否定
```
输入: "患者不是没有头痛"
处理: 会被识别为否定，建议用户改为"患者有头痛"
```

### 情况2: 否定词在句中
```
输入: "患者头痛，但无发热"
处理: ✅ 正确识别"无发热"并移除
```

### 情况3: 家族史在描述中
```
输入: "患者发育迟缓，家族史：父亲也有类似症状"
处理: ✅ 正确移除家族史部分
```

---

## 📊 日志示例

### 成功处理的日志
```
⚠️  查询预处理:
⚠️ 提示：
• 检测到否定症状：头痛、发热，已自动忽略
• 检测到家族史：高血压、肾病，已自动忽略（仅分析患者本人症状）

原始查询: 患者有发育迟缓，无头痛，否认发热。家族史：父亲高血压，哥哥肾病。
清理后: 患者有发育迟缓

查询长度: 8, 使用术语数: 12
搜索相关术语耗时: 42ms
Processing query: 患者有发育迟缓...
```

### 无效查询的日志
```
⚠️  查询预处理:
⚠️ 提示：
• 检测到否定症状：头痛、发热，已自动忽略

原始查询: 患者无头痛，否认发热
清理后: 

⚠️  查询清理后为空，可能全是否定症状或家族史

返回结果:
{
  hpo: "HP:0000001",
  name: "No Valid Symptoms",
  chineseName: "无有效症状",
  description: "检测到否定症状：头痛、发热，已自动忽略",
  remark: "请描述患者本人存在的症状"
}
```

---

## ✅ 验证方法

### 方法1: 查看服务端日志
启动服务器后，在终端查看预处理日志：
```bash
npm run dev
# 然后进行查询，观察日志输出
```

### 方法2: 测试用例
```typescript
// 测试否定症状
输入: "患者无头痛"
期望: 返回"无有效症状"

// 测试家族史
输入: "哥哥有肾病"
期望: 返回"无有效症状"

// 测试混合
输入: "患者有癫痫，无头痛，父亲高血压"
期望: 仅返回"癫痫"相关的HPO术语
```

---

## 🎯 最佳实践

### 用户输入建议
✅ **推荐**:
- "患者表现为发育迟缓，智力障碍"
- "患者有癫痫发作"
- "患者存在面部畸形"

❌ **避免**:
- "患者无头痛"（纯否定）
- "父亲有高血压"（纯家族史）
- "患者不是没有症状"（双重否定）

### 系统提示
当检测到否定症状或家族史时，系统会：
1. 在服务端日志中显示警告
2. 自动清理查询文本
3. 如果清理后为空，返回友好提示

---

## 🔧 故障排查

### 问题1: 否定症状仍然被识别
**检查**:
1. 查看服务端日志，确认预处理是否执行
2. 检查否定词是否在支持列表中
3. 确认服务器已重启

### 问题2: 家族史仍然被识别
**检查**:
1. 查看服务端日志，确认预处理是否执行
2. 检查家族关系词是否在支持列表中
3. 确认Prompt约束是否生效

### 问题3: 正常症状被误删
**检查**:
1. 查看预处理日志，确认被删除的内容
2. 检查是否有误匹配的模式
3. 调整正则表达式模式

---

## 📈 未来改进

### 1. 更智能的NLP处理
- 使用依存句法分析
- 理解更复杂的否定结构
- 处理隐含的否定

### 2. 家族史单独处理
- 不是简单忽略，而是单独记录
- 可选择性地包含家族史信息
- 用于遗传病分析

### 3. 用户反馈机制
- 允许用户确认预处理结果
- 手动调整被过滤的内容
- 学习用户偏好

---

**总结**: 通过预处理器和Prompt约束的双重防护，系统现在能够正确处理否定症状和家族史，确保只分析患者本人存在的症状！✅
